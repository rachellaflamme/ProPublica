---
title: "Code with web scraping function"
author: "Ru"
date: "4/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RSelenium)
library(xml2)
library(rvest)
library(dplyr)
```

```{r, include = FALSE}

#create a port and open chrome through R
remDr <- RSelenium::remoteDriver(remoteServerAddr = "localhost",
                                port = 4445L,
                                browserName = "chrome")
remDr$open()

```

```{r, include=FALSE}

url = "https://my.uscis.gov/findadoctor"

#url we want to open in R

#First step: Opening chrome in a web browser, and navigating to our page
rD <- rsDriver(chromever ="73.0.3683.68")
 remDr <- rD[["client"]]
   #navigate to the webpage 
   remDr$navigate(url)
   
   
   #find the search bar where we put in zipcode
   zipElem <- remDr$findElement("css selector","#form_data_search_location")
   #let RSelenium type in the zipcode and search 
   zipElem$sendKeysToElement(list("01063","\uE007"))  #"\uE007" is the key for "ENTER"
```

```{r function to scrape data}

my_fun <- function(x) {
  name <- x %>%
    rvest::html_nodes(".name")%>%
    rvest::html_text(trim = TRUE)
  address <- x %>%
    rvest::html_nodes(".address_top")%>%
    rvest::html_text(trim = TRUE)
  city <- x%>%
    html_nodes(".address_bottom")%>%
    html_text(trim = TRUE)
  telephone <- x %>%
    rvest::html_nodes(".telephone")%>%
    rvest::html_text(trim = TRUE)
  if (length(telephone) < 1) {
    telephone <- NA
  }
  return(list(name = name,
                address = address, 
                city = city, 
                telephone = telephone))
}
```

```{r}
doctors =data.frame()
for (i in 1:166){
  src <- xml2::read_html(remDr$getPageSource()[[1]])
  
  data <- src %>%
    rvest::html_nodes(".col-span-10") %>%
    purrr::map_df(my_fun)
  
  remDr$findElement("css selector","#populated_addresses > div:nth-child(11) > div > div.next > button")$clickElement()
Sys.sleep(1)
  doctors = rbind(doctors,data)
}
View(doctors) 
```

```{r}
remDr$close()
   # stop the selenium server
   rD[["server"]]$stop()
``` 
