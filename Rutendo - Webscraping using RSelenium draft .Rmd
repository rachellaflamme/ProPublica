---
title: "Practice in R"
author: "Ru"
date: "2/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(RSelenium)
library(xml2)
library(rvest)
library(dplyr)
```

Goals for the week:
Using RSelenium: 
  >Open chrome in a web browser --done
  >Navigate to a certain page and open it  -- done
  > Find the search element --done. I used CSS selectors 
    >Input a 5-digit zipcode -- done. I used 01063
  > Search -- done. used the RSelenium code 
    > 10 results should pop up  -- done 
    > Find a way to put these in a data frame  -- still working. 
  > Click next  -- done 

#Find a way to get the doctors' information: Combining RSelenium and rvest

```{r, include=FALSE}
remDr <- RSelenium::remoteDriver(remoteServerAddr = "localhost",
                                port = 4445L,
                                browserName = "chrome")
remDr$open()
```

```{r, include=FALSE}
url = "https://my.uscis.gov/findadoctor"

#First step: Opening chrome in a web browser, and navigating to our page
rD <- rsDriver()
   remDr <- rD[["client"]]
   #navigate to the webpage 
   remDr$navigate(url)
   
   
   #find the search bar where we put in zipcode
   zipElem <- remDr$findElement("css selector","#form_data_search_location")
   #let RSelenium type in the zipcode and search 
   zipElem$sendKeysToElement(list("01063","\uE007")) 
   
   #"\uE007" is the key for "ENTER"
```

data-go-to-page="2"
html_attr()
```{r}
#xml2::read_html(remDr$getPageSource()[[1]])%>%
 #   rvest::html_attr(".data-go-to-page")
```


#scrape using rvest

```{r}

doctors = xml2::read_html(remDr$getPageSource()[[1]])%>%
<<<<<<< HEAD
  rvest::html_nodes(".name")%>%
  rvest::html_text(trim = TRUE)%>%
  dplyr::data_frame(doctor_name = .)
=======
  rvest::html_nodes(".name")
doctors
#%>%
 # rvest::html_text(trim = TRUE)
#%>%
 # dplyr::data_frame(doctor_name = .)

if (is.na(rvest::html_nodes(".name"))) {
  doctors
  
}
  
#  find: class = doctors-div
#  doctor-name col-span-8
#  doctor-telephone
>>>>>>> 5c72a74631257ef6ea0f3490cc5b166d7354fecd

address <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".address_top")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(address = .)

city <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".address_bottom")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(city = .)

phone <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".telephone")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(phone_number = .)
doctors

scrapeddf <- data.frame(doctors, address,city)
scrapeddf
```

#If statements:

```{r}

ifelse(xml2::read_html(remDr$getPageSource()[[1]])%>%
    rvest::html_nodes(".name")%>%
    rvest::html_text(trim = TRUE)%>% purrr::map_int(nchar) == 0,NA,
xml2::read_html(remDr$getPageSource()[[1]])%>%
    rvest::html_nodes(".name")%>%
    rvest::html_text(trim = TRUE))
```

#on to the next button ...
```{r}
#find what css selector the 'NEXT' button uses 
nextBtn <- remDr$findElement("css selector","#populated_addresses > div:nth-child(11) > div > div.next > button")

#click the next button
nextBtn$clickElement()
```

#Is it reading doctors 11-21? 
```{r}
#scrape the next page
doc = xml2::read_html(remDr$getPageSource()[[1]])%>%
  rvest::html_nodes(".name")%>%
  rvest::html_text(trim = TRUE)%>%
  dplyr::data_frame(doctor_name = .)
doc
```


#close and stop the server
```{r}
remDr$close()
   # stop the selenium server
   rD[["server"]]$stop()
```

#Next steps:
  1. Try piecing the two together in a function. This step will involve many other steps. 
  2. See if you can use the div class "col-span-10" to just scrape everything at once(I tried it once and it's returning rows not columns)
  3. Create a for-loop 
  
-- function that parses ten doctors 

  --lapply or map 
  
  purr::map_df(x, parse_ten_doctors) function
  
  could use doctors[i]
  
  use function that returns 
--if statements for doctor's names

```{r}
num_pages = 5 
rD <- rsDriver()
remDr <- rD[["client"]]
url = "https://my.uscis.gov/findadoctor"
remDr$navigate(url)
zipElem <- remDr$findElement("css selector","#form_data_search_location")
zipElem$sendKeysToElement(list("01063","\uE007"))


for (i in 1:5){
  doctors = xml2::read_html(remDr$getPageSource()[[1]])%>%
  rvest::html_nodes(".name")%>%
  rvest::html_text(trim = TRUE)%>%
  dplyr::data_frame(doctor_name = .)

address <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".address_top")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(address = .)

city <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".address_bottom")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(city = .)

phone <- xml2::read_html(remDr$getPageSource()[[1]])%>%
  html_nodes(".telephone")%>%
  html_text(trim = TRUE)%>%
  dplyr::data_frame(phone_number = .)
}
```

```{r}
for (i in 1:5){
  #get doctors, scrape 
  doctors = xml2::read_html(remDr$getPageSource()[[1]])%>%
  rvest::html_nodes(".name")%>%
  rvest::html_text(trim = TRUE)
  doctor[i] = doctors[i]
  #click next 
  nextBtn <- remDr$findElement("css selector","#populated_addresses > div:nth-child(11) > div > div.next > button")

#click the next button
nextBtn$clickElement()
}

```

```{r, eval= FALSE}
while (TRUE) {
  #grab data 
  xml2::read_html(remDr$getPageSource()[[1]])%>%
  rvest::html_nodes(".name")%>%
  rvest::html_text(trim = TRUE)
  #click next 
  nextBtn <- remDr$findElement("css selector","#populated_addresses > div:nth-child(11) > div > div.next > button")

  #click the next button
  nextBtn$clickElement()
}
```




  
  
  
  

